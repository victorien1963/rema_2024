<?phpdefine( "ROOTPATH", "../../" );
include( ROOTPATH."includes/admin.inc.php" );
include( "language/".$sLan.".php" );
include( "func/upload.inc.php" );
needauth( 0 );
#---------------------------------------------#
$step = $_REQUEST['step'];$groupid = $_REQUEST['groupid'];if ( $step == "add" ){		$title = htmlspecialchars( $_POST['title'] );		$pagefolder = htmlspecialchars( $_POST['pagefolder'] );		$url = htmlspecialchars( $_POST['url'] );		$memo = htmlspecialchars( $_POST['memo'] );		$body = $_POST['body'];		$pic = $_FILES['jpg'];		trylimit( "_page", 20, "id" );		$body = url2path( $body );		if ( $title == "" )		{				err( $strHtmNotice1, "", "" );		}		if ( 200 < strlen( $title ) )		{				err( $strHtmNotice2, "", "" );		}		if ( 65000 < strlen( $body ) )		{				err( $strHtmNotice3, "", "" );		}				if ( 0 < $pic['size'] )		{				$nowdate = date( "Ymd", time( ) );				$picpath = "../pics/".$nowdate;				@mkdir( $picpath, 511 );				$uppath = "page/pics/".$nowdate;				$arr = newuploadimage( $pic['tmp_name'], $pic['type'], $pic['size'], $uppath);				if ( $arr[0] != "err" )				{						$src = $arr[3];				}				else				{						err( $arr[1], "", "" );				}		}		else		{				$src = "";		}		if ( $pagefolder != "" )		{				if ( strlen( $pagefolder ) < 1 || 16 < strlen( $pagefolder ) )				{						err( $strHtmNotice11, "", "" );				}				if ( !preg_match( "/^[0-9a-z]{0,16}\$/i", $pagefolder ) )				{						err( $strHtmNotice11, "", "" );				}				if ( strstr( $pagefolder, "/" ) || strstr( $pagefolder, "." ) )				{						err( $strHtmNotice11, "", "" );				}				$arr = array( "index", "main", "default", "detail", "admin", "images", "includes", "language", "module", "page", "templates", "js", "css" );				if ( in_array( $pagefolder, $arr ) == true )				{						err( $strHtmNotice12, "", "" );				}				$fsql->query( "select id from {P}_page where groupid='{$groupid}' and pagefolder='{$pagefolder}'" );				if ( $fsql->next_record( ) )				{						err( $strHtmNotice13, "", "" );				}				$fsql->query( "select folder from {P}_page_group where id='{$groupid}'" );				if ( $fsql->next_record( ) )				{						$folder = $fsql->f( "folder" );				}				$pagename = $folder."_".$pagefolder;				$fd = fopen( "../temp.php", "r" );				$str = fread( $fd, "2000" );				$str = str_replace( "TEMP", $pagename, $str );				fclose( $fd );				$filename = "../".$folder."/".$pagefolder.".php";				$fp = fopen( $filename, "w" );				fwrite( $fp, $str );				fclose( $fp );				@chmod( $filename, 493 );				$msql->query( "insert into {P}_base_pageset set 			`name`='{$title}',			`coltype`='page',			`pagename`='{$pagename}',			`buildhtml`='0'		" );		}		$msql->query( "select max(xuhao) from {P}_page where groupid='{$groupid}'" );		if ( $msql->next_record( ) )		{				$newxuhao = $msql->f( "max(xuhao)" ) + 1;		}		$msql->query( "insert into {P}_page set 	groupid='{$groupid}',	title='{$title}',	memo='{$memo}',	xuhao='{$newxuhao}',	pagefolder='{$pagefolder}',	url='{$url}',	src='{$src}',	body='{$body}'	" );		sayok( $strHtmNotice7, "index.php?groupid=".$groupid, "" );}$msql->query( "select max(id) from {P}_page" );if ( $msql->next_record( ) ){		$ftempname = $msql->f( "max(id)" );}?><!DOCTYPE html><html lang="en">  <head>    <meta charset="utf-8">    <title><?php echo $strAdminTitle; ?></title>	    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="description" content="">    <meta name="author" content="">    <!-- Bootstrap core CSS -->    <link rel="stylesheet" href="../../base/admin/assets/css/bootstrap.min.css">    <link rel="stylesheet" href="../../base/admin/assets/css/fonts.css">	<link rel="stylesheet" href="../../base/admin/assets/font-awesome/css/font-awesome.min.css">		<!-- PAGE LEVEL PLUGINS STYLES -->	<link rel="stylesheet" href="../../base/admin/assets/css/plugins/footable/footable.min.css">	<link rel="stylesheet" href="../../base/admin/assets/css/plugins/select2/select2.css">	<link rel="stylesheet" href="../../base/admin/assets/css/plugins/bootstrap-select/bootstrap-select.min.css">	<link rel="stylesheet" href="../../base/admin/assets/css/plugins/bootstrap-wysihtml/bootstrap-wysihtml5.css">	<link rel="stylesheet" href="../../base/admin/assets/css/plugins/datetime/bootstrap-datetimepicker.min.css">	<link rel="stylesheet" href="../../base/admin/assets/css/plugins/bootstrap-datepicker/datepicker.css">			<!-- REQUIRE FOR SPEECH COMMANDS -->	<link rel="stylesheet" type="text/css" href="../../base/admin/assets/css/plugins/gritter/jquery.gritter.css" />	    <!-- Tc core CSS -->	<link id="qstyle" rel="stylesheet" href="../../base/admin/assets/css/themes/style.css">		    <!-- Add custom CSS here -->	<!-- End custom CSS here -->	    <!--[if lt IE 9]>    <script src="../../base/admin/assets/js/html5shiv.js"></script>    <script src="../../base/admin/assets/js/respond.min.js"></script>    <![endif]-->      </head>  <body style="background-color:#f5f5f5;">	<div id="right-wrapper"><!-- START MAIN PAGE CONTENT --><div class="tc-tabs">	<ul class="nav nav-tabs">		<li class="active"><a href="#tab1" class="tab" data-toggle="tab"><i class="fa fa-pencil bigger-130"></i> 網頁編輯</a></li>		<li><a href="#tab2" class="tab" data-toggle="tab"><i class="fa fa-exchange bigger-130"></i> 多國翻譯</a></li>	</ul>	<!-- Tab panes -->	<div class="tab-content">		<div class="tab-pane active" id="tab1">			<!-- Tab1 開始 -->			<form action="page_add.php" method="post" enctype="multipart/form-data" name="form" id="addPageForm" class="form-horizontal" role="form">	<div class="form-group">		<label class="col-sm-1 control-label"><?php echo $strGroupSel1; ?></label>		<div class="col-sm-6">			<select class="form-control" name="groupid" id="groupid">				<?php				$msql->query( "select * from {P}_page_group" );				while ( $msql->next_record( ) )				{						$lgroupid = $msql->f( "id" );						$groupname = $msql->f( "groupname" );						if ( $groupid == $lgroupid )						{								echo "<option value='".$lgroupid."' selected>".$groupname."</option>";						}						else						{								echo "<option value='".$lgroupid."'>".$groupname."</option>";						}				}				?>			</select>		</div>	</div>	<div class="form-group">		<label class="col-sm-1 control-label"><?php echo $strPagePbModle; ?></label>		<div class="col-sm-6">			<select class="form-control" name="modiselmodle" id="modiselmodle">				<option value="1" <?php echo seld( $modiselmodle, "1" ); ?>><?php echo $strPageFolderS2; ?></option>            	<option value="0" <?php echo seld( $modiselmodle, "0" ); ?>><?php echo $strPageFolderS1; ?></option>			</select>		</div>	</div>	<div class="form-group" id="tr_fold" >		<label class="col-sm-1 control-label"><font color="#FF0000">*</font><?php echo $strPagePbName; ?></label>		<div class="col-sm-6">			<div class="col-sm-12 input-group">				<input type="text" name="pagefolder" id="pagefolder" placeholder="<?php echo $strPagePbName; ?>" value="<?php echo $pagefolder; ?>" class="form-control" maxlength="30">				<span class="input-group-addon">.php</span>			</div>		</div>	</div>	<div class="form-group">		<label class="col-sm-1 control-label"><font color="#FF0000">*</font><?php echo $strPageTitle; ?></label>		<div class="col-sm-6">			<input type="text" name="title" id="title" placeholder="<?php echo $strPageTitle; ?>" value="<?php echo $title; ?>" class="form-control" maxlength="200">		</div>	</div>	<div class="form-group">		<label class="col-sm-1 control-label"><?php echo $strPagePicSrc; ?></label>		<div class="col-sm-6">			<div class="col-sm-12 input-group">				<span class="input-group-btn">					<span class="btn btn-file">						瀏覽 <input type="file" name="jpg" id="jpg" multiple="">					</span>				</span>				<input type="text" class="form-control" readonly="">			</div>		</div>	</div>	<div class="form-group">		<label class="col-sm-1 control-label"><?php echo $strPageCon; ?></label>		<div class="col-sm-8">			<textarea name="body" style="width:100%;height:400px;visibility:hidden;"><?php echo $body; ?></textarea>			<input type="hidden" name="step" value="add" />			<input type="hidden" name="id" value="<?php echo $id; ?>" />		</div>	</div>	<div class="form-group">		<label class="col-sm-1 control-label"><?php echo $strPageMemo; ?></label>		<div class="col-sm-6">			<textarea name="memo" id="memo" rows="5" class="form-control" id="memo"><?php echo $memo; ?></textarea>		</div>	</div>	<div class="form-group">		<label class="col-sm-1 control-label"><?php echo $strPageToUrl; ?></label>		<div class="col-sm-6">			<input type="text" name="url" id="url" placeholder="請輸入連結網址" value="<?php echo $url; ?>" class="form-control" maxlength="200">		</div>	</div>	<div class="form-actions">		<div class="form-group">			<div class="col-sm-offset-1 col-sm-10">				<button type="submit" name="submit" class="btn btn-primary"  <?php echo switchdis( 120 ); ?>><?php echo $strSubmit; ?></button>			</div>		</div>	</div></form>			<div class="clearfix"></div>			<!-- Tab1 結束 -->		</div>		<div class="tab-pane" id="tab2">			<div class="alert note note-info">				<!--button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button-->				<h4><i class="fa fa-tags"></i> 系統提醒</h4>				<hr class="separator">				<p>若要編輯多國翻譯，請送出新建資料後，再重新進入編輯。</p>			</div>			<div class="clearfix"></div>			<!-- Tab2 結束 -->		</div>	</div></div>	<!-- END MAIN PAGE CONTENT --></div>	<!-- core JavaScript -->    <script src="../../base/admin/assets/js/jquery.min.js"></script>    <script src="../../base/admin/assets/js/bootstrap.min.js"></script>	<script src="../../base/admin/assets/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>	<script src="../../base/admin/assets/js/plugins/pace/pace.min.js"></script>	<script src="../../base/admin/assets/js/plugins/iframeautoheight/jquery.autoheight.js"></script>			<!-- Themes Core Scripts -->		<script src="../../base/admin/assets/js/main.js"></script>			<!-- PAGE LEVEL PLUGINS JS -->	<script src="../../base/admin/assets/js/plugins/footable/footable.min.js"></script>		<script src="../../base/admin/assets/js/plugins/datatables/jquery.dataTables.min.js"></script>	<script src="../../base/admin/assets/js/plugins/datatables/datatables.js"></script>	<script src="../../base/admin/assets/js/plugins/datatables/datatables.responsive.js"></script>		<script src="../../base/admin/assets/js/plugins/duallistbox/jquery.bootstrap-duallistbox.min.js"></script>	<script src="../../base/admin/assets/js/plugins/select2/select2.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-select/bootstrap-select.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>	<script src="../../base/admin/assets/js/plugins/masked-input/jquery.maskedinput.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-wysihtml/wysihtml.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-wysihtml/bootstrap-wysihtml.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-markdown/markdown.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-markdown/bootstrap-markdown.js"></script>	<script src="../../base/admin/assets/js/plugins/bootbox/bootbox.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-wysiwyg/jquery.hotkeys.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-wysiwyg/bootstrap-wysiwyg.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-wysiwyg/ek-wysiwyg.js"></script>	<script src="../../base/admin/assets/js/plugins/datetime/bootstrap-datetimepicker.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-datepicker/bootstrap-datepicker.js"></script>	<script src="../../base/admin/assets/js/plugins/fuelux/spinner.min.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-touchspin/bootstrap.touchspin.js"></script>	<script src="../../base/admin/assets/js/plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>	<script src="../../base/admin/assets/js/plugins/jquery-knob/jquery.knob.min.js"></script>	<script src="../../base/admin/assets/js/plugins/colorpickers/bootstrap-colorpicker.js"></script>	<script src="../../base/admin/assets/js/plugins/colorpickers/ek-colorpicker.js"></script>		<!-- REQUIRE FOR SPEECH COMMANDS -->	<script src="../../base/admin/assets/js/speech-commands.js"></script>	<script src="../../base/admin/assets/js/plugins/gritter/jquery.gritter.min.js"></script>			<!-- initial page level scripts for examples -->	<script src="../../base/admin/assets/js/plugins/slimscroll/jquery.slimscroll.init.js"></script>	<script src="../../base/admin/assets/js/plugins/footable/footable.init.js"></script>	<script src="../../base/admin/assets/js/plugins/datatables/datatables.init.js"></script>			<!-- wayhunt & module -->	<script src="../../base/js/form.js"></script>	<script src="../../base/js/custom.js"></script>	<script src="js/frame.js"></script>	<script src="../../kedit/kindeditor_up.js"></script>	<script charset="utf-8" src="../../kedit/lang/zh_TW.js"></script>	<script>		KindEditor.ready(function(K) {			var editor = K.create('textarea[name="body"]', {				uploadJson : '../../kedit/php/upload_json.php?attachPath=page/pics/',				fileManagerJson : '../../kedit/php/file_manager_json.php?attachPath=page/pics/',				allowFlashUpload : false,				allowMediaUpload : false,				allowFileManager : true,				designMode : false,				langType : 'zh_TW',				filterMode: false,				afterBlur: function () { editor.sync(); }			});		});	</script>	<script src="js/page.js"></script>			<script>		$(document).ready(function(){			//載入時隱藏選單			$('#sidemenu, #topmenu', window.parent.document).removeClass('in');			//頁面麵包屑			$('#breadcrumb', window.parent.document).html('<li><a href="../../base/admin/index.php">Home</a></li><li>網頁</li>');			$('#pagetitle', window.parent.document).html('<?php echo $strHtmEdit;?> <span class="sub-title" id="subtitle"><?php echo $strHtmAdd; ?></span>');			//呼叫左側功能選單			$().getMenuGroup('page');		});	</script>			<script>		// Custome File Input		$(document).on('change', '.btn-file :file', function() {			var input = $(this),			numFiles = input.get(0).files ? input.get(0).files.length : 1,			label = input.val().replace(/\\/g, '<?php echo $SiteUrl;?>').replace(/.*\//, '');			input.trigger('fileselect', [numFiles, label]);		});		$(document).ready( function() {			$('.btn-file :file').on('fileselect', function(event, numFiles, label) {        				var input = $(this).parents('.input-group').find(':text'),				log = numFiles > 1 ? numFiles + ' files selected' : label;        				if( input.length ) {					input.val(log);				} else {					if( log ) alert(log);				}        			});		});        $(document).ready(function() {        	$(".tab").click(function () {        		setTimeout(function () {                     window.parent.doIframe();                 }, 0);        	});		});    </script>  </body></html>